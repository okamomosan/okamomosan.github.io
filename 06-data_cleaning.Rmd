```{r include = FALSE}
library(tidyverse)
```

# データの前処理

- 本章の説明がわからない人は、森知晴先生のすばらしい動画たちを参考にしよう！
1. [データフレームの操作 in R](https://youtu.be/96AZJmGNass)  

## 前処理

- 集めたデータを分析ができる形に加工することを「前処理」という
- 地味だけど、「データ分析の８割は前処理」と言われるくらい大事な作業
- 本章では、[以前導入した`tidyverse`のパッケージ][パッケージのインストール]を使った前処理のキホンを説明
- まずは以下のコードを実行して`tidyverse`を呼び出そう[^1]

```{r}
library(tidyverse)
```

## パイプによる処理

- `tidyverse`を呼び出すと、パイプ演算子(`%>%`)と呼ばれるものが使えるようになる[^2] [^3]
- パイプを使いこなせるととても便利！（Rが化ける！）
- 例えば、`x`というベクトルの平均を求めるには、次のようにすればよかった
```{r}
x <- c(1,2,3,4,5)

sd(x)
```
- 同じことを、パイプを使って以下のように書ける

```{r}
x %>% sd()
```

- 要するに、**引数をパイプで繋いで関数の中に入れてあげるイメージ**
- ベクトルだけでなく、**どんなものでもパイプで繋げられる**
- 例えば、前章で作った`df`というデータフレームの中身を、パイプを使って確認しよう

```{r include=FALSE}
name <- c("Tanaka", "Suzuki", "Okada", "Watanabe")
age <- c(10, 18, 36, 23) #年齢のベクトルの作成
height <- c(149.5, 153.0, 171.0, 174.5)
weight <- c(36, 65, 58, 127)
gender <- c("male", "female", "male", "male") 
df <- data.frame(name, age, height, weight, gender)
```

```{r}
df %>% head() #データフレームもパイプで繋げられる
```

- 関数同士をパイプで繋ぐこともできる

```{r}
read.csv("data/sokutei.csv") %>% head() 
```

- また、**パイプはいくらでも繋げられる**
- 結果を変数に格納することもできる

```{r}
sd_x <- 
  x %>% 
  var() %>% #xの分散を計算
  sqrt()　  #上の答えの平方根を計算

#分散の平方根が標準偏差だった
#だから、先のsd(x)の答えと同じになる
sd_x 
```

- **どんなものの処理でも、いくらで簡単に繋げられる**のがパイプのすごいところ！
- このあとデータの前処理で使ってみると、パイプの便利さがわかるはず




## 変数（列）の抽出・削除
- `tidyverse`の中の`dplyr`パッケージには、データの前処理に役立つ様々な関数が用意されている
- データフレームから特定の変数（列）を抽出したいことがよくある
- そんな時は、`dplyr`パッケージに収録された`select()`を使う
- データを匿名にするために、先ほどのデータフレーム`df`から、変数`name`以外の変数を抽出したいとする

```{r}
df %>% 
  select(age, height, weight, gender) 
```

- もしくは、同じことを`df`から、変数`name`を除外することでも、同じ結果が得られる
- この場合、`select()`の引数で、取り除きたい変数の前に`-`か`!`を付ければ良い

```{r}
df %>% 
  select(-name) # 変数の前に-か!を付けると、その変数を取り除ける
```

## 変数名の変更

- 変数名を変えたい時は、`rename()`を使う
- `df`の中の`age`という変数の名前を`toshi`に変えたい場合を考える

```{r}
df %>% 
  rename(toshi = age) # 引数は「変更後の変数名 = 変更前の変数名」
```

- もしくは、先ほどの`select()`を使い、変数の抽出とまとめて変数名を変更することもできる
- `df`から`name`を除外した上で、`age`の名前を`toshi`に変更する場合を考える

```{r}
df %>% 
  select(toshi = age, height, weight, gender)
```

 
## データ（行）の抽出
- 一定の条件を満たすデータのみを抜き出したいことがよくある
- そんな時は、`dplyr`パッケージに収録された`filter()`を使う
- 年齢が１８歳以上の人（`age`が18以上）のデータのみ抜き出してみよう

```{r}
df %>% 
  filter(age >= 18) # filter()の引数に条件式（後述）を書く
```

## 条件式のキホン
- 先のコードの中に出てきた`age >= 18`は「bmiが19以上」の意味
- 以下を使って条件式を書く[^4]

|関係演算子|書き方|意味|
|:----|:----|:----|
|>|a > b|aはbよりも大きいか？|
|>=|a >= b|aはb以上か？|
|<|a < b|aはbよりも小さいか？|
|<=|a <= b|aはb以下か？|
|==|a == b|aはbと等しいか？|
|!=|a != b|aはbと等しくないか？|
|%in%|a %in% c(a, b, c)|aはc(a, b, c)のグループに含まれるか？|

|論理演算子|構文|意味|
|:----|:----|:----|
|!|!(a==b)|aとbは等しくないか
|&| a & b |aかつb（ベクトルに対して使う）
|&&| a && b |aかつb（スカラーに対して使う）
| \| | a  \|  b |aまたはb（ベクトルに対して使う）
|\|\|| a  \|\|  b |aまたはb（スカラーに対して使う）

##### 練習問題 {-} 
- 先の先のデータフレーム`df`から、以下の条件を満たす人のデータを抽出しなさい
- ただし、いずれの問題も`select()`は一度しか使ってはいけない  <br>
  
1.  `age`が18歳以上かつ`weight`が60kg未満の人
2. 女性である
3. 男性ではない  



## 変数の追加

##### キホン：{-}

- 新しい変数を作る時は、`dplyr`パッケージに収録された`mutate()`を使う
- 前章で作った`df`というデータフレームにBMIの変数を追加してみよう  
（BMI ＝ 体重kg ÷ (身長m)$^2$）  

```{r}
df <- df %>% 
  mutate(bmi = weight / (height/100)^2) #BMIの変数を作成しdfに上書き

df
```

##### 2つに条件分岐する変数の作成：{-}

- `age`が18未満の時に`1`、18歳以上の時に`0`となるダミー変数`is_child`を作りたいとする
- この時は、`mutate()`の中で`if_else()`を使い、次の条件式を書く

```{r}
df <- df %>% 
  mutate(is_child = 
           if_else(
             age < 18, #if_else()の１つめの引数は条件式
             1, #2つめの引数は条件式がTRUEの時の戻り値
             0 #３つめの引数は条件式がFALSEの時の戻り値
           )) 

df
```

##### 複雑に条件分岐する変数の作成：{-}

- `if_else()`を入れ子にすれば、3つ以上に条件分岐する変数も作れる
- しかし、3つ以上に条件分岐する場合は`case_when`を使った方が便利
- 例えば世界保健機関(WHO)は、BMIを使って以下の基準で肥満度を分類している

|BMI値|分類|
|:----|:----|
|16未満|痩せすぎ|
|16.00〜16.99以下|痩せ|
|17.00〜18.49以下|痩せぎみ|
|18.50〜24.99以下|普通体重|
|25.00〜29.99以下|前肥満|
|30.00〜34.99以下|肥満(1度)|
|35.00〜39.99以下|肥満(2度)|
|40.00以上|肥満(3度)|

- これを表す変数`fat`を作りたい場合は以下のように書く

```{r}
df <- df %>% 
  mutate( fat = 
           case_when(
             bmi < 16 ~ "痩せすぎ",
             bmi >= 16 & bmi < 17 ~ "痩せ",
             bmi >= 17 & bmi < 18.5 ~ "痩せぎみ",
             bmi >= 18.50 & bmi < 25 ~ "普通体重",
             bmi >= 25 & bmi < 30  ~ "前肥満",
             bmi >= 30 & bmi < 35 ~ "肥満(1度)",
             bmi >= 35 & bmi < 40 ~ "肥満(2度)",
             #その他の条件の戻り値はTRUE~を使う
             TRUE~"肥満(3度)" #もちろん、bmi >= 40 ~ "肥満(3度)",と書いても良い
           )) 

df
```

## データの並び替え

- データフレームの中のある変数について並べ替えたい時は、`dplyr`パッケージに収録された`arrange()`を使う
- 例えば、先の`df`を`age`の若い順に並び替えたい時は、次のようにする

```{r}

df <- df %>% arrange(age)

# 年齢が高い人から順に並べたい時はarrange(-age)

df

```

## データの集計と計算
- データを集計し計算する時には、`dplyr`パッケージの`summarise()`を使う[^5]
- わかりにくいので具体例で説明する
- `df`の中の`age`の平均をとって`mean_age`という変数を作りたい時は、次のようにする

```{r}
df %>%
  summarise(mean_age = mean(age))
```

- `mean(df$age)`でも同じ結果が得られるので、これだけでは何が便利かわからないかもしれない
- `summarise()`は`group_by()`という関数と組み合わせて真価を発揮する
- `group_by()`は、データをグループ分けするための関数
- 例えば、男女ごとに平均年齢を求めたい時は、次のようにする

```{r}
df %>%
  group_by(gender) %>% #男女に分ける
  summarise(mean_age = mean(age)) #分けたグループごとに平均年齢を計算
```

- `summarise()`はまとめて複数の要約をすることもできる
- 例えば、男性と女性の人数を求めた上で、男女別に身長の平均、中央値、標準偏差を求めたい時は、次のようにする

```{r}
df %>%
  group_by(gender) %>% #男女に分ける
  summarise(n = n(),
    　　　　height_mean = mean(height),
    　　　　height_median = median(height),
            height_sd = sd(height), 
    　　　　#女性は１人だけでデータがばらつかない
    　　　　#よって、標準偏差が計算できず欠損値(NA)となる
            ) 
```

## 演習問題  

1. １章で作った`zemi`のプロジェクトフォルダ内に`data`というフォルダを作りなさい   
1. `wooldridge`のパッケージを呼び出しなさい（必要ならインストールすること）  
1. `data("saving")`を実行して、wooldridgeに収録された`saving`というデータを読み込みなさい
1. `head(saving)`を実行して、`saving`の中身を確認しなさい
1. `saving`に、saving_rateという名前の貯蓄を収入で割った（sav/inc）変数を追加しなさい
1. `saving`から、`black`という変数を削除しなさい
1. `saving`を`inc`の高い順に並べ替えなさい
1. 上の３つの操作を、パイプ関数を使ってひと繋ぎで実行し、`saving_modified`というオブジェクトに保存しなさい

# ```{r}
# library(wooldridge)
# data("saving")
# head(saving)
# saving_modified <-
#   saving %>%
#   mutate(saving_rate = sav / inc) %>%
#   select(-black) %>%
#   arrange(-inc)
# saving_modified
# ```

[^1]: エラーが出る場合は、[以前の章][パッケージのインストール]を参考にパッケージが正しくインストールされているか確認しよう。
[^2]: 厳密には、`tidyverse`にも含まる`magrittr`パッケージを呼び出すと使えるようになる。
[^3]: Rのver4.1.0以降は、`tidyverse`がなくてもパイプ（`|>`）が使えるようになったが、現在主流の`%>%`の説明をする。
[^4]: 条件式は、それを満たすときに`TRUE`、満たさない時に`FALSE`を返す。先の`filter(bmi >= 19) `は、条件式が`TRUE`となる行のみを抜き出していた。
[^5]: `summarize()`と書いても良い